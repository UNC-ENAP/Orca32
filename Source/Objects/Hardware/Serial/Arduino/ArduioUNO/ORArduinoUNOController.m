//--------------------------------------------------------
// ORArduinoUNOController
// Created by Mark  A. Howe on Wed 10/17/2012
// Code partially generated by the OrcaCodeWizard. Written by Mark A. Howe.
// Copyright (c) 2012 University of North Carolina. All rights reserved.
//-----------------------------------------------------------
//This program was prepared for the Regents of the University of 
//North Carolina sponsored in part by the United States 
//Department of Energy (DOE) under Grant #DE-FG02-97ER41020. 
//The University has certain rights in the program pursuant to 
//the contract and the program should not be copied or distributed 
//outside your organization.  The DOE and the University of 
//North Carolina reserve all rights in the program. Neither the authors,
//University of North Carolina, or U.S. Government make any warranty, 
//express or implied, or assume any liability or responsibility 
//for the use of this software.
//-------------------------------------------------------------
#pragma mark •••Imported Files

#import "ORArduinoUNOController.h"
#import "ORArduinoUNOModel.h"
#import "ORSerialPort.h"
#import "OHexFormatter.h"
#import "ORSerialPortController.h"

@implementation ORArduinoUNOController

#pragma mark •••Initialization

- (id) init
{
	self = [super initWithWindowNibName:@"ArduinoUNO"];
	return self;
}

- (void) dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
	[super dealloc];
}

- (void) awakeFromNib
{	
 	[super awakeFromNib];	
}

#pragma mark •••Notifications

- (void) registerNotificationObservers
{
	NSNotificationCenter* notifyCenter = [NSNotificationCenter defaultCenter];
    [super registerNotificationObservers];
	
    [notifyCenter addObserver : self
                     selector : @selector(pollTimeChanged:)
                         name : ORArduinoUNOModelPollTimeChanged
                       object : nil];
	
    [notifyCenter addObserver : self
                     selector : @selector(lockChanged:)
                         name : ORRunStatusChangedNotification
                       object : nil];
    
    [notifyCenter addObserver : self
                     selector : @selector(lockChanged:)
                         name : ORArduinoUNOLock
                        object: nil];
    
    [notifyCenter addObserver : self
                     selector : @selector(lockChanged:)
                         name : ORSerialPortModelPortStateChanged
						object: model];	
	
	[notifyCenter addObserver : self
                     selector : @selector(adcChanged:)
                         name : ORArduinoUNOModelAdcChanged
						object: model];	

	
	[serialPortController registerNotificationObservers];

}

- (void) setModel:(id)aModel
{
	[super setModel:aModel];
	[[self window] setTitle:[NSString stringWithFormat:@"ArduinoUNO (%lu)",[model uniqueIdNumber]]];
}


- (void) updateWindow
{
    [super updateWindow];
    [self lockChanged:nil];
	[self adcChanged:nil];
	[self pollTimeChanged:nil];
    [self updateButtons];
	[serialPortController updateWindow];
}


- (void) checkGlobalSecurity
{
    BOOL secure = [[[NSUserDefaults standardUserDefaults] objectForKey:OROrcaSecurityEnabled] boolValue];
    [gSecurity setLock:ORArduinoUNOLock to:secure];
    [lockButton setEnabled:secure];
}

- (void) lockChanged:(NSNotification*)aNotification
{
	[self updateButtons];
}

- (BOOL) portLocked
{
	return [gSecurity isLocked:ORArduinoUNOLock];;
}

- (void) updateButtons
{
    BOOL locked = [gSecurity isLocked:ORArduinoUNOLock];
	//BOOL portOpen = [[model serialPort] isOpen];
    [lockButton setState: locked];
	[serialPortController updateButtons:locked];
    [pollTimePopup	setEnabled:!locked];
}

- (void) pollTimeChanged:(NSNotification*)aNotification
{
	[pollTimePopup selectItemWithTag:[model pollTime]];
}

- (void) adcChanged:(NSNotification*)aNote
{
    if(aNote == nil){
        short i;
        for(i=0;i<kNumArduinoUNOAdcChannels;i++){
            [[adcMatrix cellAtRow:i column:0] setIntValue:[model adc:i]];
        }
    }
    else {
        int chan = [[[aNote userInfo] objectForKey:@"Channel"] intValue];
        [[adcMatrix cellAtRow:chan column:0] setIntValue:[model adc:chan]];
    }
}

#pragma mark •••Actions


- (IBAction) lockAction:(id) sender
{
    [gSecurity tryToSetLock:ORArduinoUNOLock to:[sender intValue] forWindow:[self window]];
}

- (IBAction) updateAllAction:(id)sender
{
	[model updateAll];
}

- (IBAction) pollTimeAction:(id)sender
{
	[model setPollTime:[[sender selectedItem] tag]];
}

@end

